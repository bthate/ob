#!/usr/bin/env python3
# This file is placed in the Public Domain.

name = "ob"

import builtins
import os
import readline
import sys

from ob.krn import Kernel, builtin

k = Kernel()
builtin("k", k)

from ob.clt import Client
from ob.int import builtin
from ob.krn import Kernel
from ob.obj import cfg
from ob.trm import wrap

def cprint(*args):
    print(*args)
    sys.stdout.flush()

class CLI(Client):

    def error(self, e):
        cprint(e.exc)
        raise Restart

    def raw(self, txt):
        cprint(txt)

class Console(CLI):

    def handle(self, e):
        super().handle(e)
        e.wait()

    def poll(self):
        return input("> ")

def main():
    cfg.wd = os.path.expanduser("~/.%s" % name)
    k = Kernel()
    k.boot(name)
    k.start()
    builtin("k", k)
    if k.cfg.txt and (not k.opts("c") or not k.cfg.m):
        c = CLI()
        return k.cmd(c, k.cfg.otxt)
    if k.cfg.m or k.opts("c"):
        c = Console()
        c.start()
        k.wait()

wrap(main)
